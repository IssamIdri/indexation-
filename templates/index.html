{% extends "base.html" %}
{% set hide_flash = true %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">

{% if indexation_success %}
  <div class="indexation-success-message" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
    <div class="success-alert" style="display: flex !important; visibility: visible !important; opacity: 1 !important;">
      <span class="success-icon">‚úì</span>
      <span class="success-text">Indexation termin√©e</span>
    </div>
  </div>
{% endif %}

<div class="card">
  <h3>Indexer un dossier ou fichier local</h3>
  <form action="{{ url_for('index_path') }}" method="post" id="index-form" class="index-form" enctype="multipart/form-data">
    <div class="file-type-selector">
      <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Types de fichiers √† indexer :</label>
      <div class="file-type-checkboxes" style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="file_types" value=".txt" checked class="file-type-checkbox">
          <span>.txt</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="file_types" value=".docx" checked class="file-type-checkbox">
          <span>.docx</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="file_types" value=".html" checked class="file-type-checkbox">
          <span>.html / .htm</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="file_types" value=".pdf" checked class="file-type-checkbox">
          <span>.pdf</span>
        </label>
      </div>
    </div>
    <div class="file-selector-section">
      <div class="file-input-wrapper">
        <input type="file" id="folder-picker" webkitdirectory directory multiple style="display: none;">
        <input type="file" id="file-picker" accept=".txt,.html,.htm,.docx,.pdf" multiple style="display: none;">
        <input type="hidden" name="folder_path" id="folder_path">
      </div>
      <div class="file-buttons">
        <button type="button" id="btn-choose-folder" class="btn-file">
          üìÅ Choisir un dossier
        </button>
        <button type="button" id="btn-choose-file" class="btn-file">
          üìÑ Choisir un ou plusieurs fichiers
        </button>
      </div>
      <div id="selected-path" class="selected-path"></div>
    </div>
    <div class="form-actions">
      <button type="submit" id="btn-index" disabled>Indexer</button>
    </div>
  </form>
  <div class="manual-path-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
    <details>
      <summary style="cursor: pointer; color: #666; font-size: 14px;">Ou saisir le chemin manuellement</summary>
      <form action="{{ url_for('index_path') }}" method="post" style="margin-top: 15px;">
        <div class="row">
          <input type="text" name="folder_path" placeholder="C:\...\mon_dossier" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          <button type="submit" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">Indexer</button>
        </div>
      </form>
    </details>
  </div>
  <span class="muted small">S√©lectionnez les types de fichiers √† indexer ci-dessus. Formats disponibles : .txt, .html, .docx, .pdf (parcours r√©cursif pour les dossiers).</span>
</div>

{% if summaries %}
<div class="card">
  <h3>Top mots par document (Top-5)</h3>
  <div class="table-wrap">
    <table class="result-table">
      <thead><tr><th>Document</th><th>Top mots √ó fr√©quences</th></tr></thead>
      <tbody>
        {% for s in summaries %}
        <tr>
          <td>{{ s.name }}</td>
          <td>
            {% for w,f in s.top %}
              <span class="chip">{{ w }} √ó {{ f }}</span>
            {% endfor %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <p class="muted small">Ces stats sont calcul√©es c√¥t√© back apr√®s lemmatisation et filtrage (mots &lt; 2 caract√®res supprim√©s).</p>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  const folderPicker = document.getElementById('folder-picker');
  const filePicker = document.getElementById('file-picker');
  const btnChooseFolder = document.getElementById('btn-choose-folder');
  const btnChooseFile = document.getElementById('btn-choose-file');
  const selectedPathDiv = document.getElementById('selected-path');
  const btnIndex = document.getElementById('btn-index');
  const form = document.getElementById('index-form');
  const fileTypeCheckboxes = document.querySelectorAll('.file-type-checkbox');
  
  let selectedFiles = null;
  let isFolderSelection = false;

  // Fonction pour obtenir les types de fichiers s√©lectionn√©s
  function getSelectedFileTypes() {
    const selectedTypes = [];
    fileTypeCheckboxes.forEach(checkbox => {
      if (checkbox.checked) {
        selectedTypes.push(checkbox.value);
      }
    });
    // Ajouter .htm si .html est s√©lectionn√©
    if (selectedTypes.includes('.html')) {
      selectedTypes.push('.htm');
    }
    return selectedTypes;
  }

  // R√©initialiser l'affichage si les types changent
  fileTypeCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const selectedTypes = getSelectedFileTypes();
      if (selectedTypes.length === 0) {
        alert('Veuillez s√©lectionner au moins un type de fichier.');
        checkbox.checked = true; // R√©activer la case
        return;
      }
      // Mettre √† jour l'affichage si des fichiers sont d√©j√† s√©lectionn√©s
      if (selectedFiles) {
        updateFileList(selectedFiles, isFolderSelection);
      }
    });
  });

  // R√©initialiser les autres inputs quand on en s√©lectionne un
  folderPicker.addEventListener('change', function() {
    filePicker.value = '';
    selectedFiles = folderPicker.files;
    isFolderSelection = true;
    updateFileList(selectedFiles, true);
  });

  filePicker.addEventListener('change', function() {
    folderPicker.value = '';
    selectedFiles = filePicker.files;
    isFolderSelection = false;
    updateFileList(selectedFiles, false);
  });

  // G√©rer le clic sur "Choisir un dossier"
  btnChooseFolder.addEventListener('click', function() {
    folderPicker.click();
  });

  // G√©rer le clic sur "Choisir un fichier"
  btnChooseFile.addEventListener('click', function() {
    filePicker.click();
  });

  // G√©rer la soumission du formulaire
  form.addEventListener('submit', function(e) {
    if (!selectedFiles || selectedFiles.length === 0) {
      e.preventDefault();
      alert('Veuillez s√©lectionner des fichiers ou un dossier.');
      return;
    }

    // Cr√©er un FormData avec les fichiers
    const formData = new FormData();
    
    // Obtenir les types de fichiers s√©lectionn√©s
    const selectedTypes = getSelectedFileTypes();
    if (selectedTypes.length === 0) {
      e.preventDefault();
      alert('Veuillez s√©lectionner au moins un type de fichier.');
      return;
    }
    
    // Ajouter les types s√©lectionn√©s au FormData
    selectedTypes.forEach(type => {
      formData.append('file_types', type);
    });
    
    // Ajouter tous les fichiers valides selon les types s√©lectionn√©s
    let hasValidFiles = false;
    const filePaths = {};

    let fileIndex = 0;
    for (let i = 0; i < selectedFiles.length; i++) {
      const file = selectedFiles[i];
      const ext = '.' + file.name.split('.').pop().toLowerCase();
      
      if (selectedTypes.includes(ext)) {
        // Ajouter le fichier (l'ordre sera pr√©serv√©)
        formData.append('files', file);
        
        // Stocker le chemin relatif par index (pour correspondre √† l'ordre)
        if (isFolderSelection && file.webkitRelativePath) {
          filePaths[String(fileIndex)] = file.webkitRelativePath;
        } else {
          filePaths[String(fileIndex)] = file.name;
        }
        
        fileIndex++;
        hasValidFiles = true;
      }
    }

    if (!hasValidFiles) {
      e.preventDefault();
      const typesList = selectedTypes.join(', ');
      alert(`Aucun fichier valide s√©lectionn√© parmi les types choisis (${typesList}).`);
      return;
    }

    // Ajouter les chemins relatifs comme JSON
    formData.append('file_paths', JSON.stringify(filePaths));

    // Remplacer la soumission normale par une soumission avec FormData
    e.preventDefault();
    
    // D√©sactiver le bouton pendant l'upload
    btnIndex.disabled = true;
    btnIndex.textContent = 'Indexation en cours...';

    fetch(form.action, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.redirected) {
        window.location.href = response.url;
      } else {
        return response.text().then(text => {
          throw new Error('Erreur lors de l\'indexation');
        });
      }
    })
    .catch(error => {
      console.error('Erreur:', error);
      alert('Erreur lors de l\'indexation: ' + error.message);
      btnIndex.disabled = false;
      btnIndex.textContent = 'Indexer';
    });
  });

  function updateFileList(files, isFolder) {
    if (!files || files.length === 0) {
      selectedPathDiv.innerHTML = '';
      selectedPathDiv.style.display = 'none';
      btnIndex.disabled = true;
      return;
    }

    // Obtenir les types de fichiers s√©lectionn√©s
    const selectedTypes = getSelectedFileTypes();
    
    // Compter les fichiers valides selon les types s√©lectionn√©s
    let validCount = 0;
    let totalCount = files.length;
    let folderName = '';

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const ext = '.' + file.name.split('.').pop().toLowerCase();
      if (selectedTypes.includes(ext)) {
        validCount++;
        if (isFolder && !folderName) {
          // Extraire le nom du dossier depuis webkitRelativePath
          const webkitPath = file.webkitRelativePath || '';
          folderName = webkitPath.split('/')[0] || 'Dossier s√©lectionn√©';
        }
      }
    }

    if (validCount === 0) {
      const typesList = selectedTypes.length > 0 ? selectedTypes.join(', ') : 'aucun type s√©lectionn√©';
      selectedPathDiv.innerHTML = `<div style="color: #d32f2f; padding: 10px;">Aucun fichier valide s√©lectionn√© parmi les types choisis (${typesList}).</div>`;
      selectedPathDiv.style.display = 'block';
      btnIndex.disabled = true;
      return;
    }

    // Afficher les informations
    const selectedTypesList = selectedTypes.join(', ');
    let infoHtml = '';
    if (isFolder) {
      infoHtml = `
        <div style="margin: 10px 0; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
          <strong>üìÅ Dossier s√©lectionn√©:</strong> ${folderName}<br>
          <strong>Fichiers valides:</strong> ${validCount} sur ${totalCount} fichiers trouv√©s<br>
          <strong>Types s√©lectionn√©s:</strong> ${selectedTypesList}<br>
          <small style="color: #666;">Pr√™t √† indexer. Cliquez sur "Indexer" pour commencer.</small>
        </div>
      `;
    } else {
      const validFiles = Array.from(files).filter(f => {
        const ext = '.' + f.name.split('.').pop().toLowerCase();
        return selectedTypes.includes(ext);
      });
      const fileNames = validFiles.slice(0, 3).map(f => f.name).join(', ');
      const moreFiles = validFiles.length > 3 ? ` et ${validFiles.length - 3} autre(s)` : '';
      infoHtml = `
        <div style="margin: 10px 0; padding: 12px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
          <strong>üìÑ Fichiers s√©lectionn√©s:</strong> ${fileNames}${moreFiles}<br>
          <strong>Total:</strong> ${validCount} fichier(s) valide(s) (types: ${selectedTypesList})<br>
          <small style="color: #666;">Pr√™t √† indexer. Cliquez sur "Indexer" pour commencer.</small>
        </div>
      `;
    }

    selectedPathDiv.innerHTML = infoHtml;
    selectedPathDiv.style.display = 'block';
    btnIndex.disabled = false;
  }
});
</script>
{% endblock %}
